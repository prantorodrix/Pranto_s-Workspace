<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pranto's Workspace v4.0</title>
    <link rel="icon" type="image/png" href="note.png"> 
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script>
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
    </script>
    
    <style>
        :root {
            --font-main: 'Poppins', sans-serif;
            --font-tech: 'Rajdhani', sans-serif;
            --sidebar-width: 320px;
            --header-height: 70px;
            
            /* Light Mode Palette */
            --bg-light: #eef2f6;
            --glass-light: rgba(255, 255, 255, 0.75);
            --border-light: rgba(255, 255, 255, 0.8);
            --text-light: #334155;
            --shadow-light: 0 8px 30px rgba(0,0,0,0.08);
            
            /* Dark Mode Palette */
            --bg-dark: #0f172a;
            --glass-dark: rgba(30, 41, 59, 0.7);
            --border-dark: rgba(255, 255, 255, 0.08);
            --text-dark: #e2e8f0;
            --shadow-dark: 0 8px 30px rgba(0,0,0,0.3);

            --accent: #06b6d4;
            --accent-grad: linear-gradient(135deg, #06b6d4, #8b5cf6);
        }

        [data-bs-theme="light"] { 
            --bg-body: var(--bg-light); 
            --glass-bg: var(--glass-light); 
            --border-color: var(--border-light);
            --text-body: var(--text-light);
            --card-shadow: var(--shadow-light);
            --nav-bg: rgba(255,255,255,0.9);
        }
        
        [data-bs-theme="dark"] { 
            --bg-body: var(--bg-dark); 
            --glass-bg: var(--glass-dark); 
            --border-color: var(--border-dark);
            --text-body: var(--text-dark);
            --card-shadow: var(--shadow-dark);
            --nav-bg: rgba(15, 23, 42, 0.9);
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-body);
            overflow: hidden;
            transition: background 0.3s ease;
        }

        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        /* Glass Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .glass-card:hover { box-shadow: 0 12px 40px rgba(0,0,0,0.15); transform: translateY(-2px); }

        /* Header */
        #top-bar {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
            z-index: 1040; padding: 0 1.5rem; display: flex; align-items: center; justify-content: space-between;
            background: var(--nav-bg); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        /* Navigation Menu (Original Style) */
        .nav-center {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            display: flex; gap: 1rem;
        }
        .btn-nav {
            background: transparent; border: none; color: var(--text-body); font-weight: 600; font-size: 0.9rem;
            opacity: 0.7; transition: 0.2s; text-decoration: none; padding: 5px 10px; border-radius: 8px;
        }
        .btn-nav:hover, .btn-nav.active { opacity: 1; background: rgba(6, 182, 212, 0.1); color: var(--accent); }
        
        /* Dropdowns */
        .drop-box { position: relative; cursor: pointer; display: flex; align-items: center; }
        .drop-menu {
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(15px);
            background: var(--glass-bg); color: var(--text-body); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 8px; min-width: 170px;
            opacity: 0; visibility: hidden; transition: 0.2s cubic-bezier(0.2, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 4px;
        }
        .drop-box:hover .drop-menu { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(5px); }
        .d-item { 
            text-decoration: none; color: var(--text-body); font-size: 0.85rem; padding: 8px 12px; 
            border-radius: 8px; transition: 0.2s; font-weight: 500; display: flex; align-items: center; gap: 8px; 
        }
        .d-item:hover { background: rgba(6, 182, 212, 0.15); color: var(--accent); }

        /* Sidebar & Layout */
        #main-wrapper { display: flex; height: 100vh; padding-top: var(--header-height); }
        #sidebar {
            width: var(--sidebar-width); flex-shrink: 0; height: 100%; overflow-y: auto;
            border-right: 1px solid var(--border-color); background: var(--glass-bg);
            transition: width 0.3s; padding: 1rem;
        }
        #sidebar.collapsed { width: 0; padding: 0; overflow: hidden; border: none; }
        #content-area { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        
        #resizer { width: 4px; cursor: col-resize; z-index: 100; }
        #resizer:hover { background: var(--accent); }

        /* Sticky Bar */
        #eob-display-bar {
            position: sticky; top: -10px; z-index: 1020;
            background: rgba(var(--bs-primary-rgb), 0.1); 
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px); border-radius: 12px; padding: 10px 20px;
            margin-bottom: 20px; display: none; align-items: center; gap: 15px; flex-wrap: wrap;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-left: 4px solid var(--accent);
            animation: slideDown 0.3s ease-out;
        }
        #eob-display-bar.visible { display: flex; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Inputs */
        .form-control {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); 
            color: var(--text-body); border-radius: 8px; font-family: monospace; font-size: 0.85rem;
            transition: 0.2s;
        }
        .form-control:focus { 
            background: rgba(255,255,255,0.08); border-color: var(--accent); 
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2); color: var(--text-body); 
        }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; overflow-y: auto; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .copyable { cursor: pointer; }
        .section-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; margin-bottom: 5px; display: block; font-weight: 700; color: var(--accent); }

        /* Buttons */
        .btn-glow {
            background: var(--accent-grad); border: none; color: white; border-radius: 50px;
            padding: 8px 24px; font-weight: 600; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
            transition: 0.3s;
        }
        .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(6, 182, 212, 0.6); color: white; }
        
        .btn-icon { background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--text-body); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-icon:hover { background: var(--accent); color: white; border-color: var(--accent); }

        /* Sidebar Results */
        .idr-card {
            background: rgba(255,255,255,0.02); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 12px; margin-bottom: 12px; position: relative;
            overflow: hidden;
        }
        .idr-card::before { content:''; position: absolute; left:0; top:0; bottom:0; width: 3px; background: var(--accent); }
        .idr-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; }
        .idr-val { font-weight: 600; text-align: right; }
        
        .bg-match { background: rgba(34, 197, 94, 0.2); color: #4ade80; border-radius: 4px; padding: 0 4px; }
        .bg-mismatch { background: rgba(239, 68, 68, 0.2); color: #f87171; border-radius: 4px; padding: 0 4px; }
        
        /* Tabs */
        .nav-pills-glass .nav-link {
            color: var(--text-body); background: transparent; border: 1px solid transparent;
            margin-right: 5px; border-radius: 8px; opacity: 0.7; transition: 0.2s;
        }
        .nav-pills-glass .nav-link.active {
            background: rgba(6, 182, 212, 0.15); color: var(--accent); border-color: rgba(6, 182, 212, 0.3); opacity: 1;
        }

        /* EOB Details Table */
        .eob-table-row {
            display: flex; justify-content: space-between; padding: 6px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; font-family: monospace;
        }
        .eob-table-row:last-child { border-bottom: none; }
        .eob-table-row span:last-child { font-weight: 600; }
        
        .loader { width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>

    <!-- Header -->
    <header id="top-bar">
        <div class="d-flex align-items-center gap-3">
            <span style="font-family: var(--font-tech); font-weight: 700; font-size: 1.6rem; 
                  background: var(--accent-grad); -webkit-background-clip: text; color: transparent; letter-spacing: 1px;">
                PRANTO'S WORKSPACE
            </span>
            <button id="toggle-sidebar" class="btn btn-sm btn-link text-muted"><i class="bi bi-grid-3x3-gap-fill"></i></button>
        </div>

        <!-- Center Menu -->
        <div class="nav-center d-none d-md-flex">
            <a href="index.html" class="btn-nav active"><i class="bi bi-house-door-fill"></i> Home</a>
            
            <div class="drop-box">
                <span class="btn-nav">BCBS <i class="bi bi-chevron-down ms-1" style="font-size: 0.7em;"></i></span>
                <div class="drop-menu">
                    <a href="index.html" class="d-item"><i class="bi bi-file-text"></i> IDR Tool</a>
                    <a href="nsa.html" class="d-item"><i class="bi bi-shield-lock"></i> NSA Tool</a>
                    <a href="appeal.html" class="d-item"><i class="bi bi-arrow-repeat"></i> Appeal</a>
                    <a href="email.html" class="d-item"><i class="bi bi-envelope"></i> IDR Email</a>
                    <a href="accept.html" class="d-item"><i class="bi bi-check-circle"></i> Accepted Email</a>
                </div>
            </div>
            
            <div class="drop-box">
                <span class="btn-nav">Others <i class="bi bi-chevron-down ms-1" style="font-size: 0.7em;"></i></span>
                <div class="drop-menu">
                    <a href="typing.html" class="d-item"><i class="bi bi-keyboard"></i> Typing</a>
                    <a href="game1.html" class="d-item"><i class="bi bi-controller"></i> 3D Runner</a>
                </div>
            </div>
            
            <a href="index.html" class="btn-nav">Contact Us</a>
        </div>

        <div class="d-flex align-items-center gap-2">
            <button id="processBtn" class="btn-glow"><i class="bi bi-lightning-charge-fill"></i> Extract</button>
            <button id="clearBtn" class="btn-icon text-danger"><i class="bi bi-trash3"></i></button>
            <button id="themeToggle" class="btn-icon"><i class="bi bi-palette"></i></button>
        </div>
    </header>

    <div id="main-wrapper">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom border-secondary border-opacity-10">
                <span class="small fw-bold text-muted">IDR RESULTS</span>
                <span class="badge bg-primary bg-opacity-10 text-primary" id="res-count">0</span>
            </div>
            <div id="idr-results-container"></div>
            <div id="sidebar-errors" class="alert alert-danger d-none mt-2 py-2 small fw-bold text-center border-0 bg-danger bg-opacity-10 text-danger"></div>
        </aside>
        
        <div id="resizer"></div>

        <!-- Main Content -->
        <main id="content-area">
            
            <!-- Sticky Bar -->
            <div id="eob-display-bar">
                <div id="eob-content" class="d-flex gap-4 align-items-center w-100 text-nowrap" style="font-family: var(--font-tech); font-weight: 600; font-size: 1.1rem;"></div>
            </div>

            <!-- Input Grid (Updated Layout) -->
            <div class="row g-3 mb-4">
                
                <!-- 1. IDR Inputs (Center - Largest) -->
                <div class="col-lg-7 order-lg-2">
                    <div class="glass-card p-3 h-100">
                        <div class="row g-2">
                            <div class="col-4 border-end border-secondary border-opacity-10">
                                <span class="section-label text-success">2024-25 Format</span>
                                <textarea id="idrTextInput1" class="form-control no-scrollbar mb-1" rows="1" placeholder="Paste Row 1"></textarea>
                                <textarea id="idrTextInput2" class="form-control no-scrollbar mb-1" rows="1" placeholder="Paste Row 2"></textarea>
                                <textarea id="idrTextInput3" class="form-control no-scrollbar mb-1" rows="1" placeholder="Paste Row 3"></textarea>
                                <textarea id="idrTextInput4" class="form-control no-scrollbar" rows="1" placeholder="Paste Row 4"></textarea>
                            </div>
                            <div class="col-4 border-end border-secondary border-opacity-10">
                                <span class="section-label text-warning">2022-23 Format</span>
                                <textarea id="idr2022TextInput1" class="form-control no-scrollbar mb-1" rows="1" placeholder="Paste Row 1"></textarea>
                                <textarea id="idr2022TextInput2" class="form-control no-scrollbar mb-1" rows="1" placeholder="Paste Row 2"></textarea>
                                <textarea id="idr2022TextInput3" class="form-control no-scrollbar mb-1" rows="1" placeholder="Paste Row 3"></textarea>
                                <textarea id="idr2022TextInput4" class="form-control no-scrollbar" rows="1" placeholder="Paste Row 4"></textarea>
                            </div>
                            <div class="col-4">
                                <span class="section-label text-info">2026 Format <i class="bi bi-stars"></i></span>
                                <textarea id="idr2026TextInput1" class="form-control no-scrollbar mb-1" rows="1" placeholder="Paste Row 1"></textarea>
                                <textarea id="idr2026TextInput2" class="form-control no-scrollbar mb-1" rows="1" placeholder="Paste Row 2"></textarea>
                                <div class="text-muted text-center mt-3" style="font-size:0.65rem; opacity:0.5;">Paste Excel rows directly into boxes</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Updated EOB (Left) -->
                <div class="col-lg-2 order-lg-1">
                    <div class="glass-card p-2 h-100 d-flex flex-column">
                        <span class="section-label text-primary ps-2">Updated EOB</span>
                        <textarea id="eobUpdatedInput" class="form-control no-scrollbar flex-grow-1" placeholder="Paste Full EOB Text here..."></textarea>
                    </div>
                </div>

                <!-- 3. EOB Breakdown (Right - Last) -->
                <div class="col-lg-3 order-lg-3">
                    <div class="glass-card p-3 h-100 d-flex flex-column">
                        <span class="section-label text-info">EOB Breakdown</span>
                        <div id="eob-details-grid" class="flex-grow-1 d-flex flex-column justify-content-center">
                            <div class="text-center text-muted small opacity-50">Waiting for extraction...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs & Output -->
            <div class="glass-card p-0 overflow-hidden">
                <div class="p-3 border-bottom border-secondary border-opacity-10 bg-secondary bg-opacity-10">
                    <ul class="nav nav-pills nav-pills-glass" id="noteTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-corr"><i class="bi bi-pencil-square me-1"></i> Correspondence</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-refund"><i class="bi bi-cash-stack me-1"></i> Refund</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-ineligible"><i class="bi bi-slash-circle me-1"></i> Ineligible</button></li>
                    </ul>
                </div>
                
                <div class="tab-content p-4">
                    <!-- Correspondence -->
                    <div class="tab-pane fade show active" id="tab-corr">
                        <div class="row g-4">
                            <div class="col-md-9">
                                <textarea id="note_Text" class="form-control copyable no-scrollbar" rows="8" readonly onclick="copyToClipboard(this)" placeholder="Generated note will appear here..."></textarea>
                                <div class="d-flex justify-content-end mt-1"><small class="text-muted fst-italic">*Click to copy</small></div>
                            </div>
                            <div class="col-md-3">
                                <span class="section-label">User Info</span>
                                <input type="text" id="note_Name" class="form-control mb-2" placeholder="Your Name (Required)">
                                <input type="text" id="note_Initial" class="form-control mb-3" placeholder="Initial (Auto)">
                                <button id="genNoteBtn" class="btn-glow w-100 mb-3"><i class="bi bi-stars"></i> Generate</button>
                                
                                <div id="adjustments" class="glass-card p-3 border-0 bg-primary bg-opacity-10 d-none">
                                    <div class="d-flex justify-content-between mb-1 text-info small"><span>Adj w/ PT:</span> <span id="adj-pt" class="fw-bold">--</span></div>
                                    <div class="d-flex justify-content-between text-info small"><span>Adj w/o PT:</span> <span id="adj-nopt" class="fw-bold">--</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Refund -->
                    <div class="tab-pane fade" id="tab-refund">
                        <div class="row g-4">
                            <div class="col-md-9">
                                <textarea id="refund_Note_Text" class="form-control copyable no-scrollbar" rows="8" readonly onclick="copyToClipboard(this)"></textarea>
                            </div>
                            <div class="col-md-3">
                                <span class="section-label">Refund Details</span>
                                <input type="text" id="refund_Name" class="form-control mb-2" placeholder="Name">
                                <input type="text" id="refund_Amount" class="form-control mb-2" placeholder="Amount ($)">
                                <input type="text" id="refund_Date" class="form-control mb-2" placeholder="Date (MM/DD/YY)">
                                <input type="text" id="refund_Dispute" class="form-control mb-3" placeholder="DISP-****">
                                <button id="genRefundBtn" class="btn-glow w-100">Generate</button>
                            </div>
                        </div>
                    </div>

                    <!-- Ineligible -->
                    <div class="tab-pane fade" id="tab-ineligible">
                        <div class="row g-4">
                            <div class="col-md-9">
                                <textarea id="ineligible_Note_Text" class="form-control copyable no-scrollbar" rows="8" readonly onclick="copyToClipboard(this)"></textarea>
                            </div>
                            <div class="col-md-3">
                                <span class="section-label">Details</span>
                                <input type="text" id="ineligible_Name" class="form-control mb-2" placeholder="Name">
                                <input type="text" id="ineligible_Dispute" class="form-control mb-3" placeholder="DISP-****">
                                <button id="genIneligibleBtn" class="btn-glow w-100">Generate</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="height: 50px;"></div>
        </main>
    </div>
<!-- Mouse Effect -->
    <canvas id="trail-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;pointer-events:none"></canvas><script>(function(){const canvas=document.getElementById('trail-canvas'),ctx=canvas.getContext('2d');let points=[],clickEffects=[],MAX_POINTS=60,mouse={x:-100,y:-100},frameCount=0,globalHue=200;let dragon={x:window.innerWidth/2,y:window.innerHeight/2,targetX:window.innerWidth/2,targetY:window.innerHeight/2,size:6,pulse:0,history:[]};function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}window.addEventListener('resize',resize);window.addEventListener('mousemove',(e)=>{mouse.x=e.clientX;mouse.y=e.clientY;points.push({x:mouse.x,y:mouse.y});if(points.length>MAX_POINTS)points.shift()});window.addEventListener('mousedown',(e)=>{dragon.targetX=e.clientX;dragon.targetY=e.clientY;let c=`hsla(${globalHue},100%,75%,1)`;clickEffects.push({x:e.clientX,y:e.clientY,radius:5,opacity:1,type:'ripple',color:c});for(let i=0;i<8;i++){clickEffects.push({x:e.clientX,y:e.clientY,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,size:Math.random()*6+4,angle:Math.random()*Math.PI*2,spin:Math.random()*0.2-0.1,opacity:1,type:'triangle',color:`hsla(${globalHue+Math.random()*40-20},100%,70%,1)`})}});function drawDragon(){let dx=dragon.targetX-dragon.x,dy=dragon.targetY-dragon.y;dragon.x+=dx*0.08;dragon.y+=dy*0.08;dragon.pulse+=0.08;globalHue=(globalHue+0.4)%360;let mc=`hsla(${globalHue},100%,65%,1)`;dragon.history.push({x:dragon.x,y:dragon.y});if(dragon.history.length>35)dragon.history.shift();ctx.save();if(dragon.history.length>5){for(let i=0;i<dragon.history.length-1;i+=2){let p=dragon.history[i],nP=dragon.history[i+1],r=i/dragon.history.length,a=Math.atan2(nP.y-p.y,nP.x-p.x);ctx.beginPath();ctx.strokeStyle=`hsla(${globalHue},100%,65%,${r*0.5})`;ctx.lineWidth=r*4;ctx.moveTo(p.x,p.y);ctx.lineTo(nP.x,nP.y);ctx.stroke();let rL=r*25*(1+Math.sin(dragon.pulse+i*0.5)*0.3);ctx.beginPath();ctx.lineWidth=1.5;ctx.moveTo(p.x,p.y);ctx.lineTo(p.x+Math.cos(a-Math.PI/2)*rL,p.y+Math.sin(a-Math.PI/2)*rL);ctx.moveTo(p.x,p.y);ctx.lineTo(p.x+Math.cos(a+Math.PI/2)*rL,p.y+Math.sin(a+Math.PI/2)*rL);ctx.stroke()}}ctx.translate(dragon.x,dragon.y);ctx.shadowBlur=15;ctx.shadowColor=mc;ctx.fillStyle=mc;ctx.beginPath();ctx.moveTo(10,0);ctx.lineTo(-5,-7);ctx.lineTo(-5,7);ctx.closePath();ctx.fill();ctx.fillStyle='white';ctx.beginPath();ctx.arc(2,0,3,0,Math.PI*2);ctx.fill();let mdx=mouse.x-dragon.x,mdy=mouse.y-dragon.y,md=Math.sqrt(mdx*mdx+mdy*mdy)||1;ctx.fillStyle='black';ctx.beginPath();ctx.arc((mdx/md)*1.5,(mdy/md)*1.5,1.2,0,Math.PI*2);ctx.fill();ctx.restore()}function drawClickEffects(){for(let i=0;i<clickEffects.length;i++){const e=clickEffects[i];ctx.globalAlpha=e.opacity;ctx.strokeStyle=ctx.fillStyle=e.color;if(e.type==='ripple'){ctx.lineWidth=3;ctx.beginPath();ctx.arc(e.x,e.y,e.radius,0,Math.PI*2);ctx.stroke();e.radius+=4;e.opacity-=0.03}else if(e.type==='triangle'){ctx.save();ctx.translate(e.x,e.y);ctx.rotate(e.angle);ctx.beginPath();ctx.moveTo(e.size,0);ctx.lineTo(-e.size/2,e.size/2);ctx.lineTo(-e.size/2,-e.size/2);ctx.closePath();ctx.fill();ctx.restore();e.x+=e.vx;e.y+=e.vy;e.angle+=e.spin;e.opacity-=0.02}if(e.opacity<=0){clickEffects.splice(i,1);i--}}ctx.globalAlpha=1}function drawTrail(){if(points.length<3)return;ctx.lineCap='round';for(let i=1;i<points.length;i++){const r=i/points.length,p1=points[i-1],p2=points[i];ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);const g=ctx.createLinearGradient(p1.x,p1.y,p2.x,p2.y);g.addColorStop(0,`hsla(${(globalHue+40)%360},100%,50%,0)`);g.addColorStop(1,`hsla(${globalHue},100%,65%,${r*0.3})`);ctx.strokeStyle=g;ctx.lineWidth=r*6;ctx.stroke()}}function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);frameCount++;if(frameCount%2===0&&points.length>0)points.shift();drawTrail();drawClickEffects();drawDragon();requestAnimationFrame(animate)}resize();animate()})()</script>
    <!-- Script Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initSidebar();
            initPersistent();
            initAnimations();
        });

        const els = {
            process: document.getElementById('processBtn'),
            clear: document.getElementById('clearBtn'),
            eobIn: document.getElementById('eobUpdatedInput'),
            results: document.getElementById('idr-results-container'),
            eobBar: document.getElementById('eob-display-bar'),
            eobContent: document.getElementById('eob-content'),
            eobGrid: document.getElementById('eob-details-grid'),
            resCount: document.getElementById('res-count'),
            errorDiv: document.getElementById('sidebar-errors'),
            idr24: [1,2,3,4].map(i => document.getElementById(`idrTextInput${i}`)),
            idr22: [1,2,3,4].map(i => document.getElementById(`idr2022TextInput${i}`)),
            idr26: [1,2].map(i => document.getElementById(`idr2026TextInput${i}`))
        };

        let globalData = { eob: null, idrRows: [] };

        // --- Formatters ---
        const fmtMoney = (n) => isNaN(n) ? '$0.00' : '$' + n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        const parseMoney = (s) => parseFloat((s||'').replace(/[$,\s]/g, '')) || 0;
        const getDate = () => { const d = new Date(); return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${String(d.getFullYear()).slice(-2)}`; };

        // --- Parsing: EOB ---
        function parseEOB(txt) {
            if(!txt) return null;
            const getVal = (reg) => {
                const match = txt.match(reg);
                if(!match) return 0;
                const sub = txt.substring(match.index + match[0].length);
                return parseMoney(sub.split(/[\r\n]+/)[0].trim());
            };

            const billed = getVal(/(Total Bill|Billed Amount)\s*:?/i);
            const paid = getVal(/(^|[\r\n])(Plan Payment|Total Payment|Plan Paid|Paid Amount|Total Paid)\s*:?/i);
            const coins = getVal(/(Coinsurance Amount|Coinsurance)\s*:?/i);
            const copay = getVal(/(Copay Amount|Copay)\s*:?/i);
            const deduc = getVal(/(Deductible Amount|Deductible)\s*:?/i);
            const addl = getVal(/(Insurance Current Paid Amount|Additional Paid)\s*:?/i);
            
            let ptResp = coins + copay + deduc;
            if(ptResp === 0) ptResp = getVal(/(Copay\/Deductible Amount|Responsibility)\s*:?/i);

            const tkt = (txt.match(/(Patient Account Number|Pt Acct No)\s*:?[\s\r\n]+([^\r\n]+)/i) || [])[2]?.trim() || 'N/A';
            const clm = (txt.match(/(Claim I?D|Claim No|Claim Number|Control Number)\s*:?[\s\r\n]+([^\r\n]+)/i) || [])[2]?.trim() || 'N/A';
            const prov = (txt.match(/(Billing Provider Name|Provider Name)\s*:?[\s\r\n]+([^\r\n]+)/i) || [])[2]?.trim() || '';

            return { tkt, clm, prov, billed, paid, ptResp, addl, coins, copay, deduc };
        }

        // --- Parsing: IDR (Updated Logic for Addl Date) ---
        function parseIDR() {
            const allInputs = [
                ...els.idr24.map(e => ({ v: e.value, m: '24' })),
                ...els.idr22.map(e => ({ v: e.value, m: '22' })),
                ...els.idr26.map(e => ({ v: e.value, m: '26' }))
            ];
            
            // Map Index: pd = Payment Date (Additional Received Date)
            const maps = {
                '24': { t:2, i:1, c:3, cpt:4, wl:17, add:18, pd:19, m:8 },
                '22': { t:1, i:5, c:2, cpt:3, wl:19, add:20, pd:21, m:8 },
                '26': { t:3, i:1, c:4, cpt:5, wl:20, add:21, pd:22, m:10 }
            };

            const rows = [];
            allInputs.forEach((o, idx) => {
                if(!o.v.trim()) return;
                const cols = o.v.split(/\t/);
                const map = maps[o.m];
                const g = (i) => cols[i]?.trim() || '--';

                const pmtDateVal = g(map.pd);
                // LOGIC: If Date exists (not empty, not --) -> Received, else Waiting
                const status = (pmtDateVal !== '--' && pmtDateVal !== '') ? 'Received' : 'Waiting';

                rows.push({
                    idx: idx,
                    type: o.m === '26' ? '2026' : (o.m==='24'?'2024':'2022'),
                    ticket: g(map.t), idr: g(map.i), claim: g(map.c), cpt: g(map.cpt),
                    wl: g(map.wl), addl: g(map.add), 
                    addlStatus: status, // Logic Based on Date Column
                    mediator: g(map.m)
                });
            });
            return rows;
        }

        // --- Processing ---
        els.process.addEventListener('click', () => {
            const btn = els.process;
            const old = btn.innerHTML;
            btn.innerHTML = `<span class="loader"></span>`;
            
            setTimeout(() => {
                setError(null);
                globalData.eob = parseEOB(els.eobIn.value);
                globalData.idrRows = parseIDR();
                
                renderEOB();
                renderSidebar();
                btn.innerHTML = old;
            }, 300);
        });

        function renderEOB() {
            if(!globalData.eob) {
                els.eobBar.classList.remove('visible');
                els.eobGrid.innerHTML = `<div class="text-center text-muted small opacity-50">Waiting for extraction...</div>`;
                return;
            }
            const e = globalData.eob;
            const sep = `<span class="opacity-25 mx-2">|</span>`;
            
            // Sticky Bar
            els.eobContent.innerHTML = `
                <span class="text-info">${e.tkt}</span>${sep}
                <span>${e.clm}</span>${sep}
                <span class="text-warning">Bill: ${fmtMoney(e.billed)}</span>${sep}
                <span class="text-success">Paid: ${fmtMoney(e.paid)}</span>${sep}
                <span class="text-danger">PT: ${fmtMoney(e.ptResp)}</span>${sep}
                <span id="bar-addl" class="fw-bold text-primary">Addl: ${fmtMoney(e.addl)}</span>
                <span class="ms-auto small fw-normal opacity-50 text-truncate" style="max-width:150px">${e.prov}</span>
            `;
            els.eobBar.classList.add('visible');

            // Breakdown Grid (Right Side)
            els.eobGrid.innerHTML = `
                <div class="eob-table-row"><span>Billed</span> <span>${fmtMoney(e.billed)}</span></div>
                <div class="eob-table-row"><span>Paid</span> <span>${fmtMoney(e.paid)}</span></div>
                <div class="eob-table-row"><span>Coins</span> <span>${fmtMoney(e.coins)}</span></div>
                <div class="eob-table-row"><span>Copay</span> <span>${fmtMoney(e.copay)}</span></div>
                <div class="eob-table-row"><span>Deduct</span> <span>${fmtMoney(e.deduc)}</span></div>
                <div class="eob-table-row text-info"><span>Addl</span> <span>${fmtMoney(e.addl)}</span></div>
            `;
        }

        function renderSidebar() {
            const div = els.results;
            div.innerHTML = '';
            els.resCount.innerText = globalData.idrRows.length;
            
            globalData.idrRows.forEach((r, i) => {
                const isMatch = globalData.eob && globalData.eob.tkt === r.ticket;
                
                const card = document.createElement('div');
                card.className = 'idr-card glass-card shadow-sm p-2 mb-2';
                // Additional Status based on Logic
                const addlColor = r.addlStatus === 'Received' ? 'text-success' : 'text-warning';

                card.innerHTML = `
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold text-primary small">#${r.idr}</span>
                        <span class="badge bg-secondary bg-opacity-25 text-secondary" style="font-size:0.65rem">${r.type}</span>
                    </div>
                    <div class="idr-row"><span>Ticket</span> <span class="idr-val ${isMatch?'bg-match':'bg-mismatch'}">${r.ticket}</span></div>
                    <div class="idr-row"><span>Claim</span> <span class="idr-val">${r.claim}</span></div>
                    <div class="idr-row"><span>Addl</span> <span class="idr-val fw-bold" data-addl="${parseMoney(r.addl)}">${r.addl}</span></div>
                    <div class="idr-row"><span>Date Status</span> <span class="idr-val ${addlColor}">${r.addlStatus}</span></div>
                    
                    <div class="mt-2 pt-2 border-top border-secondary border-opacity-10">
                        <div class="d-flex align-items-center justify-content-between mb-1">
                            <span class="small opacity-75">Status</span>
                            <input class="form-control form-control-sm py-0 w-50 text-end wl-in" value="${r.wl}" data-i="${i}" oninput="handleWL(this)">
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="small opacity-75">Refund</span>
                            <input class="form-control form-control-sm py-0 w-50 text-end ref-in" placeholder="Rec/Wait" data-i="${i}" onfocus="this.select()" oninput="handleRefund(this)">
                        </div>
                    </div>
                `;
                div.appendChild(card);
            });
            
            // Addl Sum Logic
            if(globalData.eob) {
                const sum = globalData.idrRows.reduce((a,b)=>a+parseMoney(b.addl),0);
                const bar = document.getElementById('bar-addl');
                if(Math.abs(sum - globalData.eob.addl) < 0.05) {
                    bar?.classList.add('text-success'); bar?.classList.remove('text-primary');
                    document.querySelectorAll('[data-addl]').forEach(e=>e.classList.add('bg-match'));
                } else {
                    bar?.classList.add('text-danger'); bar?.classList.remove('text-primary');
                    document.querySelectorAll('[data-addl]').forEach(e=>e.classList.add('bg-mismatch'));
                }
            }
            // Trigger WL check
            document.querySelectorAll('.wl-in').forEach(e=>handleWL(e));
        }

        // --- Logic: Handling Inputs ---
        window.handleWL = (el) => {
            const v = el.value.toLowerCase();
            const grp = el.closest('.idr-card');
            const ref = grp.querySelector('.ref-in');
            
            if(v.includes('win') || v.includes('close')) {
                ref.disabled = false;
                if(v.includes('win')) ref.placeholder = "Required";
            } else if(v.includes('lose')) {
                ref.disabled = true; ref.value = ''; ref.placeholder = "Disabled";
                ref.classList.remove('is-invalid');
            }
        };

        window.handleRefund = (el) => {
            const v = el.value.toLowerCase();
            if(v === 'r') el.value = 'Received';
            if(v === 'w') el.value = 'Waiting';
            if(el.value) el.classList.remove('is-invalid');
        };

        // --- Note Generation ---
        document.getElementById('genNoteBtn').addEventListener('click', () => {
            const nameEl = document.getElementById('note_Name');
            if(!nameEl.value.trim()) { nameEl.classList.add('is-invalid'); setError("Name is required!"); return; }
            nameEl.classList.remove('is-invalid');
            setError(null);

            const rows = [];
            let error = false;

            document.querySelectorAll('.idr-card').forEach((card, i) => {
                const wl = card.querySelector('.wl-in').value.toLowerCase();
                const ref = card.querySelector('.ref-in').value.toLowerCase();
                const org = globalData.idrRows[i];

                if(wl.includes('win') && !ref) {
                    card.querySelector('.ref-in').classList.add('is-invalid');
                    error = true;
                }

                rows.push({
                    wl: wl, ref: ref,
                    addl: org.addl,
                    addlRec: org.addlStatus === 'Received',
                    idr: org.idr, cpt: org.cpt, med: org.mediator
                });
            });

            if(error) { setError("Refund status missing for WIN cases!"); return; }

            // Init Logic
            let init = document.getElementById('note_Initial').value.trim();
            let allDone = true;
            
            rows.forEach(r => {
                if(r.wl.includes('win')) {
                    if(!r.ref.startsWith('r')) allDone = false;
                    if(!r.addlRec) allDone = false;
                } else if(r.wl.includes('close')) {
                    if(!r.ref.startsWith('r')) allDone = false;
                } else if(r.wl.includes('lose')) {
                    if(!r.addlRec) allDone = false;
                }
            });

            if(!init) init = allDone ? "FINAL REVIEW" : "IDR FOLLOW UP";

            // Note Text
            const e = globalData.eob || { clm:rows[0]?.claim||'N/A', billed:0, paid:0, ptResp:0 };
            
            let txt = `${getDate()}>${init}>${nameEl.value}>WORKING ON TRACKING SHEET. `;
            txt += `CLAIM: ${e.clm}; TOTAL BILL ${fmtMoney(e.billed)}, INS PAID ${fmtMoney(e.paid)}, PT RESPONSIBLITY ${fmtMoney(e.ptResp)}. NEGOTIATION AND IDR DONE. `;
            
            rows.forEach(r => {
                const wlUp = r.wl.toUpperCase();
                if(wlUp.includes('CLOSE')) {
                    txt += `${r.idr}: STATUS IS ${wlUp}. `;
                    if(r.ref.startsWith('r')) txt += "WE RECEIVED FEE REFUND. ";
                    else if(r.ref.startsWith('w')) txt += "WE ARE WAITING FOR FEE REFUND. ";
                } else {
                    txt += `${r.idr}: IDR SUBMITTED ON CPT ${r.cpt} TO MEDIATOR ${r.med}. STATUS IS ${wlUp} WITH ADDITIONAL ${r.addl}. `;
                    txt += r.addlRec ? "WE RECEIVED ADDITIONAL PAYMENT. " : "WE ARE WAITING FOR ADDITIONAL PAYMENT. ";
                    
                    if(r.wl.includes('win')) {
                        if(r.ref.startsWith('r')) txt += "WE RECEIVED FEE REFUND. ";
                        else txt += "WE ARE WAITING FOR FEE REFUND. ";
                    }
                }
            });

            if(init === "FINAL REVIEW") {
                txt += "NO FURTHER ACTION NEEDED. BALANCE TO BE ADJUSTED.";
                document.getElementById('adjustments').classList.remove('d-none');
                document.getElementById('adj-pt').innerText = fmtMoney(e.billed - (e.paid + e.ptResp));
                document.getElementById('adj-nopt').innerText = fmtMoney(e.billed - e.paid);
            } else {
                txt += "WAITING TO COMPLETE THE IDR PROCESS BEFORE ADJUSTMENT.";
                document.getElementById('adjustments').classList.add('d-none');
            }

            typeWriter(document.getElementById('note_Text'), txt.toUpperCase());
        });

        // --- Core Helpers ---
        function setError(msg) {
            const el = els.errorDiv;
            if(msg) { el.innerText = msg; el.classList.remove('d-none'); }
            else el.classList.add('d-none');
        }

        function typeWriter(el, txt) {
            el.value = ''; let i=0;
            const t = () => { if(i<txt.length) { el.value+=txt.charAt(i); i++; setTimeout(t, 2); el.scrollTop=el.scrollHeight; } };
            t();
        }

        window.copyToClipboard = (el) => { el.select(); document.execCommand('copy'); };

        function initTheme() {
            const t = document.getElementById('themeToggle');
            t.addEventListener('click', () => {
                const n = document.documentElement.getAttribute('data-bs-theme')==='dark'?'light':'dark';
                document.documentElement.setAttribute('data-bs-theme', n); localStorage.setItem('theme', n);
            });
        }
        
        function initSidebar() {
            const sb = document.getElementById('sidebar');
            document.getElementById('toggle-sidebar').addEventListener('click', () => sb.classList.toggle('collapsed'));
            
            const r = document.getElementById('resizer');
            let x=0, w=0, md=false;
            r.onmousedown = e => { md=true; x=e.clientX; w=sb.offsetWidth; document.body.style.cursor='col-resize'; };
            document.onmousemove = e => { if(md) sb.style.width = (w + e.clientX - x) + 'px'; };
            document.onmouseup = () => { md=false; document.body.style.cursor=''; };
        }

        function initPersistent() {
            ['note_Name','note_Initial'].forEach(id => {
                const e=document.getElementById(id);
                e.value=localStorage.getItem(id)||'';
                e.oninput=()=>localStorage.setItem(id,e.value);
            });
            els.clear.addEventListener('click', () => {
                document.querySelectorAll('textarea').forEach(t=>t.value='');
                document.querySelectorAll('input:not([id*="note_Name"])').forEach(i=>i.value='');
                els.eobBar.classList.remove('visible');
                els.results.innerHTML='';
                els.eobGrid.innerHTML = `<div class="text-center text-muted small opacity-50">Waiting for extraction...</div>`;
                globalData={eob:null, idrRows:[]};
                setError(null);
            });
        }

        function initAnimations() {
            const c=document.getElementById('bg-canvas'), x=c.getContext('2d');
            let w,h,p=[]; const rs=()=>{w=c.width=innerWidth; h=c.height=innerHeight;};
            window.onresize=rs; rs();
            for(let i=0;i<35;i++) p.push({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,s:Math.random()*2});
            const anim=()=>{
                x.clearRect(0,0,w,h); 
                x.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
                p.forEach(d=>{ d.x+=d.vx; d.y+=d.vy; if(d.x<0)d.x=w; if(d.x>w)d.x=0; if(d.y<0)d.y=h; if(d.y>h)d.y=0; 
                x.globalAlpha=0.08; x.beginPath(); x.arc(d.x,d.y,d.s,0,6.28); x.fill(); });
                requestAnimationFrame(anim);
            };
            anim();
        }
    </script>
</body>
</html>
